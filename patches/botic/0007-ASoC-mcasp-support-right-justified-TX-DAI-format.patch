From a1bbb279ca9dcf15a3250224a2a88149fe5f3c78 Mon Sep 17 00:00:00 2001
From: Miroslav Rudisin <miero@seznam.cz>
Date: Tue, 28 Apr 2015 21:49:41 +0200
Subject: [PATCH 07/12] ASoC: mcasp: support right-justified TX DAI format

---
 sound/soc/davinci/davinci-mcasp.c | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/sound/soc/davinci/davinci-mcasp.c b/sound/soc/davinci/davinci-mcasp.c
index de3b155..395a3a4 100644
--- a/sound/soc/davinci/davinci-mcasp.c
+++ b/sound/soc/davinci/davinci-mcasp.c
@@ -80,6 +80,7 @@ struct davinci_mcasp {
 	u8	version;
 	u8	bclk_div;
 	u16	bclk_lrclk_ratio;
+	bool	right_justified;
 	int	streams;
 	u32	irq_request[2];
 
@@ -388,6 +389,7 @@ static int davinci_mcasp_set_dai_fmt(struct snd_soc_dai *cpu_dai,
 	bool inv_fs = false;
 
 	pm_runtime_get_sync(mcasp->dev);
+	mcasp->right_justified = false;
 	switch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {
 	case SND_SOC_DAIFMT_DSP_A:
 		mcasp_clr_bits(mcasp, DAVINCI_MCASP_TXFMCTL_REG, FSXDUR);
@@ -411,6 +413,8 @@ static int davinci_mcasp_set_dai_fmt(struct snd_soc_dai *cpu_dai,
 		/* FS need to be inverted */
 		inv_fs = true;
 		break;
+	case SND_SOC_DAIFMT_RIGHT_J:
+		mcasp->right_justified = true;
 	case SND_SOC_DAIFMT_LEFT_J:
 		/* configure a full-word SYNC pulse (LRCLK) */
 		mcasp_set_bits(mcasp, DAVINCI_MCASP_TXFMCTL_REG, FSXDUR);
@@ -611,6 +615,11 @@ static int davinci_config_channel_size(struct davinci_mcasp *mcasp,
 	/* mapping of the XSSZ bit-field as described in the datasheet */
 	fmt = (word_length >> 1) - 1;
 
+	if (mcasp->right_justified) {
+		tx_rotate = 0;
+		/* TODO: RX? */
+	}
+
 	if (mcasp->op_mode != DAVINCI_MCASP_DIT_MODE) {
 		mcasp_mod_bits(mcasp, DAVINCI_MCASP_RXFMT_REG, RXSSZ(fmt),
 			       RXSSZ(0x0F));
-- 
2.1.4

